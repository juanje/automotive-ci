text
lang en_US.UTF-8
keyboard us
timezone --utc Etc/UTC
selinux --enforcing
rootpw --lock --iscrypted locked
user --name=admin --groups=wheel --iscrypted --password=\$6\$1LgwKw9aOoAi/Zy9\$Pn3ErY1E8/yEanJ98evqKEW.DZp24HTuqXPJl6GYCm8uuobAmwxLv7rGCvTRZhxtcYdmC0.XnYRSR9Sh6de3p0
sshkey --username=admin "${SSH_PUBLIC_KEY_CONTENT}"
# Add Testing-Farm public key
sshkey --username=admin "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDWmSeZiIlqtYGiPR0co8+750Nn/36YjnWfW7Y18PPMjsxeAUE05EgxgFRhAopUHVQCLJLmQnPs8+fVecBmXXYXX9m1hGHBf6Cfp4vr7V93tOiPLlTjNZe8INS6rTxk4rS7a8rca+CaHsoO1e0+RtL8IqVG8cOfaSXVH7JyiipzFrSpCA6PdkzR4vLDU2AIG/GHbQ0eNCmRIad+bcpO+smhnUJX1aiFT2C9Ro8MFivNx9z//929DocUeXoWV2Aw/QA4TfyXXzHhhLb7QAgHvpUjKEtWaWUtlMiEcHKQqtf+jQwgyBBFYDR8QQSUJ/Hrjagwu6ZTPwUVKP9rSo2JZ4GV"
user --name=edge
bootloader --timeout=1 --append="net.ifnames=0 modprobe.blacklist=vc4"
network --bootproto=dhcp --device=link --activate --onboot=on
zerombr
clearpart --all --initlabel --disklabel=msdos
autopart --nohome --noswap --type=plain
ostreesetup --nogpg --osname=${IMAGE_TYPE} --remote=${IMAGE_TYPE} --url=http://192.168.100.1/repo/ --ref=${OSTREE_REF}
poweroff
%post --log=/var/log/anaconda/post-install.log --erroronfail
# no sudo password for user admin
echo -e 'admin\tALL=(ALL)\tNOPASSWD: ALL' >> /etc/sudoers
# Make X start directly
systemctl set-default graphical.target

# Make sure the 'edge' user has no password
passwd -d edge

# Create potentially missing directories
mkdir -p /home/edge/.config/autostart

# Skip gnome's initial setup
echo 'yes' >  /home/edge/.config/gnome-initial-setup-done

# Automatically start neptune
cat > /home/edge/.config/autostart/neptune3-ui.desktop << EOF
[Desktop Entry]
Type=Application
Exec=/usr/bin/neptune3-ui
Hidden=false
NoDisplay=false
X-GNOME-Autostart-enabled=true
Name[en_US]=neptune3-ui
Comment[en_US]=Launches neptune3-ui on logging in
EOF

# Ensure we have no file system permission error
chown edge:edge -R /home/edge

# Xorg
cat > /etc/X11/xorg.conf << EOF
Section "Device"
    Identifier "Configured Video Device"
    Driver "dummy"
    #VideoRam 4096000
    #VideoRam 256000
    VideoRam 16384
EndSection

Section "Monitor"
    Identifier "Configured Monitor"
    HorizSync 5.0 - 1000.0
    VertRefresh 5.0 - 200.0
    Modeline "1600x900" 33.92 1600 1632 1760 1792 900 921 924 946
EndSection

Section "Screen"
    Identifier "Default Screen"
    Monitor "Configured Monitor"
    Device "Configured Video Device"
    DefaultDepth 24
    SubSection "Display"
        Viewport 0 0
        Depth 24
        Virtual 1600 900
    EndSubSection
EndSection
EOF

# Automatically log in as 'edge'
cat > /etc/gdm/custom.conf << EOF
## custom.conf

# GDM configuration storage

[daemon]
# Uncomment the line below to force the login screen to use Xorg
WaylandEnable=false
DefaultSession=gnome-xorg.desktop
AutomaticLoginEnable=True
AutomaticLogin=edge

[security]

[xdmcp]

[chooser]

[debug]
# Uncomment the line below to turn on debugging
#Enable=true
EOF
# Remove any persistent NIC rules generated by udev
rm -vf /etc/udev/rules.d/*persistent-net*.rules
# And ensure that we will do DHCP on eth0 on startup
cat > /etc/sysconfig/network-scripts/ifcfg-eth0 << EOF
DEVICE="eth0"
BOOTPROTO="dhcp"
ONBOOT="yes"
TYPE="Ethernet"
PERSISTENT_DHCLIENT="yes"
EOF
echo "Packages within this iot or edge image:"
echo "-----------------------------------------------------------------------"
rpm -qa | sort
echo "-----------------------------------------------------------------------"
# Note that running rpm recreates the rpm db files which aren't needed/wanted
rm -f /var/lib/rpm/__db*
echo "Zeroing out empty space."
# This forces the filesystem to reclaim space from deleted files
dd bs=1M if=/dev/zero of=/var/tmp/zeros || :
rm -f /var/tmp/zeros
echo "(Don't worry -- that out-of-space error was expected.)"
%end
